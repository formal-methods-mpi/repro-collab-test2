# .github/workflows/continue.yml
name: Milestone Router

concurrency:
  group: "milestones-${{ github.event.issue.number  }}"
  cancel-in-progress: false

on:
  issue_comment:
    types: [created, edited]

jobs:
  route:
    if: ${{ startsWith(github.event.comment.body, '/done ') && contains(github.event.issue.labels.*.name, 'newfork') }}
    runs-on: ubuntu-latest
    steps:
      - name: Extract FORK from issue body
        id: vars
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          FORK_REPO="$(echo "$ISSUE_BODY" \
            | grep -oP 'Fork repo: `\K[^`]+')"
          echo "Extracted fork repo: $FORK_REPO"
          echo "fork_repo=$FORK_REPO" >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v5
        with:
          sparse-checkout: |
            .github/scripts
          sparse-checkout-cone-mode: false
      - name: Parse slash-command
        id: parse
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          result-encoding: string
          script: |
            const run = require('./.github/scripts/parse.js');
            return await run({ github, context, core, env: process.env });
      - name: 3
        if: steps.parse.outputs.result == '3'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
                const run = require('./.github/scripts/3.js');
                return await run({ github, context, core, env: process.env });
      - name: 4
        if: steps.parse.outputs.result == '4'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/4.js');
            return await run({ github, context, core, env: process.env });
      - name: 5
        id: verify-5
        if: steps.parse.outputs.result == '5'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
          UPSTREAM_TOKEN: ${{ secrets.GH_PAT_UPSTREAM }}
          CROSSREPO_TOKEN: ${{ secrets.GH_PAT_CROSSREPO }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/5.js');
            return await run({ github, context, core, env: process.env });
      - name: 6
        if: steps.parse.outputs.result == '6'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/6.js');
            return await run({ github, context, core, env: process.env });
      - name: 7
        if: steps.parse.outputs.result == '7'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/7.js');
            return await run({ github, context, core, env: process.env });

      # Milestone 8: Build groups
      - name: 8
        if: steps.parse.outputs.result == '8'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/8.js');
            return await run({ github, context, core, env: process.env });

      # Milestone 9: Generate and upload data + Auto-trigger Milestone 10
      - name: 9
        if: steps.parse.outputs.result == '9'
        uses: actions/github-script@v7
        env:
          FORK_REPO: ${{ steps.vars.outputs.fork_repo }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/9.js');
            return await run({ github, context, core, env: process.env });

      # Failure notification step - only triggers if milestone verification steps fail
      - name: Notify on failure
        if: failure() && steps.parse.outputs.result != '-1' && steps.parse.outputs.result != ''
        uses: actions/github-script@v7
        env:
          MILESTONE: ${{ steps.parse.outputs.result }}
        with:
          github-token: ${{ secrets.GH_PAT_CROSSREPO }}
          script: |
            const run = require('./.github/scripts/fail.js');
            return await run({ github, context, core, env: process.env });
